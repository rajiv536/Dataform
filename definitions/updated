config {
  type: "assertion",
  schema: dataform.projectConfig.vars.work.dataform,
  name : "sales_tax_line_item_dtl_assertion_latest",
  tags: ["tax_audit"],
  uniqueKey: ["line_item_tax_dtl_id"],
  columns: {
    line_item_id: {
      notNull: true,
      type: "integer"
    },
    amount: {
      notNull: true,
      type: "numeric"
    },
    posting_dt: {
      notNull: true,
      type: "date"
    },
    tax_dt: {
      notNull: true,
      type: "date"
    },
    extraction_timestamp: {
      notNull: true,
      type: "timestamp"
    },
    ingestion_timestamp: {
      notNull: true,
      type: "timestamp"
    }
  }
}

WITH assertion_result AS (
  SELECT
    line_item_tax_dtl_id,
    line_item_id,
    posting_dt,
    tax_dt,
    extraction_timestamp,
    ingestion_timestamp,
    CASE
      WHEN line_item_id < 0 THEN 'Failed'
      WHEN FORMAT_DATE('%Y-%m-%d', posting_dt) != CAST(posting_dt AS STRING) THEN 'Failed'
      WHEN FORMAT_DATE('%Y-%m-%d', tax_dt) != CAST(tax_dt AS STRING) THEN 'Failed'
      ELSE 'Passed'
    END AS validation_status
  FROM
    ${ref("sales_tax_line_item_dtl")}
)

SELECT
  CASE
    WHEN COUNT(*) = 0 THEN 'Assertion Passed'
    ELSE CONCAT('Assertion Failed: ', COUNT(*), ' data with validation issues')
  END AS assertion_status
FROM
  assertion_result
WHERE
  validation_status = 'Failed';
